<!-- MIT License

Copyright (c) 2019 zuhima

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE. -->

<!-- Author : zuhima (2019.8.12)-->

<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>糸掛け曼荼羅メーカー Ver1</title>
    <script
      src="https://code.jquery.com/jquery-3.4.1.js"
      integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
      crossorigin="anonymous">
    </script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
  </head>
  <body>
    <div id="mandara_space">

    </div>
    <div id="ui">
      <div id="line_size_tag">
        Line size: <input type="text" id="line_size" size="1" /> px
      </div>
      <div id="pincount_tag">
        Pin Count (Over 3): <input type="text" id="pin_count" size="5" />
      </div>
      <div id="prime_number_selection_tag">
        Prime Number Selection: <a id="prime_number_selection"></a>
      </div>
      <div id="color_button_space">
        Color Type:
        <input type="radio" name="color_button" id="mono" value="mono" checked/>mono
        <input type="radio" name="color_button" id="gradation" value="gradation" />gradation
        <!-- <input type="radio" name="color_button" id="custom" />custom -->
      </div>
      <div id="color_input_space">
        　=>Color(example:black, #000):
        <input type="text" id="color_input" size="5"/>
      </div>
      <div id="create_button_tag">
        <input type="button" id="create_button" value="Create!" disabled/>
      </div>
    </div>
  </body>
  <style>

  </style>
  <script>
    //初期設定
    var width = 500;             //描画範囲：幅
    var height = 500;            //描画範囲：高さ
    var centerX = width / 2;     //描画範囲の中心x座標
    var centerY = height / 2;    //描画範囲の中心y座標
    var radius = 200;            //半径
    var svg = d3.select("#mandara_space").append("svg")
                .attr("width", width)
                .attr("height", height);   //描画範囲設定
    var pinCount;                //ピンの数
    var lineSize;                //線の太さ
    var color = "black";

    //Line Sizeにデフォルトの線の太さを入力
    $("#line_size").val("1");

    //Line sizeが変化したとき
    $("#line_size").change(function(){
      var val = $(this).val();     //入力されたものを取得
      if(!isNaN(val)){
        //数値が入力されたとき
        lineSize = Number(val);
      } else {
        //数値以外が入力されたとき
        $(this).val('');           //入力欄をクリア
      }
    })

    //pinCount欄が変化したとき(入力して確定したとき)
    $("#pin_count").change(function(){
      var val = $(this).val();     //入力されたものを取得
      if(!isNaN(val)){
        //数値が入力されたとき
        pinCount = Number(val);    //数値を代入
          $("#create_button").prop("disabled", false);  //createボタンを有効化
      } else {
        //数値以外が入力されたとき
        d3.selectAll("#prime_checkbox").remove();    //チェックボックスを全部消す
        $("#create_button").prop("disabled", true);  //createボタンを無効化
        return;
      }
      if(pinCount <= 3) {
        //3以下の数値を入力したとき
        d3.selectAll("#prime_checkbox").remove();    //チェックボックスを全部消す
        $("#create_button").prop("disabled", true);  //createボタンを無効か
        return;
      }

      var primeNumberList = [];     //pinCount未満の素数を格納するリスト
      primeNumberList = createPrimeNumberList(pinCount);
      //console.log(primeNumberList);

      //素数を選べるチェックボックスを作る
      d3.select("#prime_number_selection")
        .selectAll("input")
        .data(primeNumberList)
        .enter()
        .append("input")
        .attr("id", "prime_checkbox")
        .attr("type", "checkbox")
        .attr("name", "prime_checkbox")
        .attr("value", function(d){ return d; })
        .attr("checked", true)
        .text(function(d){ return d; });

      //pinCountを変更したときにあぶれたチェックボックスを消す
      d3.select("#prime_number_selection")
        .selectAll("input")
        .data(primeNumberList)
        .exit().remove();


    });

    //チェックボックスに何かしらの動きがあった時
    //動的追加したときの処理
    $(document).on("click", "#prime_checkbox", function(){
      //console.log("pass");
      $("#create_button").prop("disabled", false);   //createボタンを有効化
    });

    //createボタンが押されたとき
    $("#create_button").on("click", function(){
      d3.selectAll("#mandara").remove();             //既に描画されている曼荼羅を消す
      var selectedPrimeNumberList = [];              //選択された素数を格納するリスト
      $("#prime_checkbox:checked").each(function(){
        selectedPrimeNumberList.push($(this).val()); //チェックされている素数を取得
      });

      if(selectedPrimeNumberList.length == 0){
        //素数を選択せずにcreateボタンを押したとき
        $(this).prop("disabled", true);                   //createボタン無効化
        return;
      } else {
        //素数が選択された状態でcreateボタンを押したとき
        drawMandara(selectedPrimeNumberList, pinCount, color);   //曼荼羅を描画する
      }
      //$(this).prop("disabled", true);                     //createボタン無効化
    });

    //ラジオボタンColorTypeに変化があった時
    $("input[name='color_button']:radio").change(function(){
      var val = $(this).val();
      switch(val){
        case "mono":
          removeColorInputTag();
          d3.select("#color_input_space")
            .text("　=>Color(example:black, #000):")
            .append("input")
            .attr("type", "text")
            .attr("id", "color_input")
            .attr("size", "5")
            .append("span")
            .attr("id", "color_sample");
        break;

        case "gradation":
          removeColorInputTag();
          d3.select("#color_input_space").text("　=>Coming soon...");
        break;

        default:
        return;
      }
    })

    //色入力欄の変化を検出して動作
    $(document).on("change", "#color_input", function(){
      color = $(this).val();
      //console.log(color);
    })



//********* 関数群 ***************
    //色入力欄を消す
    function removeColorInputTag(){
      d3.select("#color_input_space").text("");
      d3.select("#color_input").remove();
    }

    //曼荼羅を描画する
    function drawMandara(primeNumList, pinCount, color){
      var degree = 360 / pinCount;                  //ピンの角度の間隔
      var radian = degree * Math.PI / 180;          //ラジアンに変換
      var pinPosX = [];
      var pinPosY = [];

      //ピンの座標を計算し(x,y)の形で格納
      for(var i = 0; i < pinCount; i++){
        pinPosX.push(centerX + radius * Math.cos(radian * i));
        pinPosY.push(centerY + radius * Math.sin(radian * i));
      }
      var pinPosXY = [];
      for(var i = 0; i < pinCount; i++){
        var pos = [];
        pos.push(pinPosX[i]);
        pos.push(pinPosY[i]);
        pinPosXY.push(pos);
      }

      //ピンを配置
      svg.selectAll("circle")
          .data(pinPosXY)
          .enter()
          .append("circle")
          .attr("id", "mandara")
          .attr("r", "2px")
          .attr("cx", function(d){ return d[0]; })
          .attr("cy", function(d){ return d[1]; });

      //線の描画
      for(var i = 0; i < primeNumList.length; i++){
        var step = Number(primeNumList[i]);
        var start = 0;
        var end = step;
        do{
          svg.append("line")
              .attr("id", "mandara")
              .attr("x1", pinPosXY[start][0])
              .attr("y1", pinPosXY[start][1])
              .attr("x2", pinPosXY[end][0])
              .attr("y2", pinPosXY[end][1])
              .attr("stroke-width", function(){ return lineSize + "px"; })
              .attr("stroke", color);
          start = end;
          end = start + step;
          if(start >= pinPosXY.length) start -= pinPosXY.length;
          if(end >= pinPosXY.length) end -= pinPosXY.length;
        }while(start != 0);
      }
      return;
    }

    //引き数未満の素数リストを作る
    function createPrimeNumberList(pinCount){
      var isPrimeNumber = [];
      //*****エラトステネスの篩******
      for(var i = 0; i < pinCount + 1; i++){
        isPrimeNumber[i] = true;
      }
      isPrimeNumber[0] = false;
      isPrimeNumber[1] = false;
      for(var i = 2; i < isPrimeNumber.length; i++){
        if(!isPrimeNumber[i]) continue;
        for(var j = 2; j * i < isPrimeNumber.length; j++){
          isPrimeNumber[i * j] = false;
        }
      }
      //************************

      var list = [];
      for(var i = 0; i < isPrimeNumber.length; i++){
        if(isPrimeNumber[i]) list.push(i);
      }

      return list;
    }
  </script>
</html>
